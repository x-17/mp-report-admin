import{_ as e,r as t,W as a,n as i,s as l,o as s,c as o,w as d,i as n,a as p,b as u,d as r,e as c,f,F as h,g as b,h as m,t as _,j as v,k as y,l as g,m as k}from"./index-b4e560e4.js";import{_ as w}from"./uni-stat-breadcrumb.15e35830.js";import{_ as T}from"./uni-notice-bar.08ec632d.js";import{_ as A}from"./uni-stat-tabs.c1e62e9b.js";import{g as I,d as x,s as D,a as C,b as S,p as q,f as F,c as $}from"./util.c5e0d5d8.js";import"./uni-tooltip.6577854d.js";const j=[{value:"今天",contrast:"昨天"},{field:"appid",title:"APPID",tooltip:""},{field:"name",title:"应用名",tooltip:""},{field:"total_devices",title:"总设备数",tooltip:"从添加统计到当前选择时间的总设备数（去重）",value:0,contrast:0},{field:"new_device_count",title:"新增设备",tooltip:"首次访问应用的设备数（以设备为判断标准，去重）",value:0,contrast:0},{field:"active_device_count",title:"活跃设备",tooltip:"访问过应用内任意页面的总设备数（去重）",value:0,contrast:0}],O=[{value:"今天",contrast:"昨天"},{field:"appid",title:"APPID",tooltip:""},{field:"name",title:"应用名",tooltip:""},{field:"total_users",title:"总用户数",tooltip:"从添加统计到当前选择时间的总用户数（去重）",value:0,contrast:0},{field:"new_user_count",title:"新增用户",tooltip:"首次访问应用的用户数（以用户为判断标准，去重）",value:0,contrast:0},{field:"active_user_count",title:"活跃用户",tooltip:"访问过应用内任意页面的总用户数（去重）",value:0,contrast:0}];const M=e({data:()=>({query:{platform_id:"",start_time:[I(1),(new Date).getTime()]},deviceTableData:[],userTableData:[],pageSize:10,pageCurrent:1,total:0,loading:!1,complete:!1,statSetting:{mode:"",day:7},statModeList:[{value:"open",text:"开启"},{value:"close",text:"关闭"},{value:"auto",text:"节能"}],showAddAppId:!1,showdbInit:!1}),onReady(){uniIDHasRole("auditor")&&t({url:"/pages/user-report/user-report"}),this.debounceGet=x((()=>{this.getAllData(this.queryStr)}),300),this.debounceGet(),this.checkAppId(),this.checkdbInit()},watch:{query:{deep:!0,handler(e){this.debounceGet(this.queryStr)}}},computed:{queryStr(){return D(this.query)+' && (dimension == "hour" || dimension == "day")'},deviceTableFields(){return this.tableFieldsMap(j)},userTableFields(){return this.tableFieldsMap(O)}},methods:{getAllData(e){this.getApps(this.queryStr,j,"device"),this.getApps(this.queryStr,O,"user")},tableFieldsMap(e){let t=[];const a=[],i=[],l=[];for(const s of e)if(s.field)if(s.hasOwnProperty("value")){const e=JSON.parse(JSON.stringify(s)),t=JSON.parse(JSON.stringify(s));"total_users"!==s.field&&"total_devices"!==s.field?(e.title="今日"+s.title,e.field=s.field+"_value",t.title="昨日"+s.title,t.field=s.field+"_contrast",a.push(e),i.push(t)):(e.field=s.field+"_value",l.push(e))}else t.push(s);return t=[...t,...a,...i,...l],t},getApps(e,t,i="device"){this.loading=!0;const l=a.database(),s=l.collection("uni-stat-result").where(e).getTemp(),o=l.collection("opendb-app-list").getTemp();l.collection(s,o).field(`${C(t,"","value")},stat_date,appid,dimension`).groupBy("appid,dimension,stat_date").groupField(S(t,"","value")).orderBy("appid","desc").get().then((e=>{let{data:a}=e.result;if(this[`${i}TableData`]=[],!a.length)return;let l=[],s=[],o=[],d=q(I(0),"",""),n=q(I(1),"","");for(const t of a){const{appid:e,name:a}=t.appid&&t.appid[0]||{};t.appid=e,t.name=a,l.indexOf(t.appid)<0&&l.push(t.appid),"hour"===t.dimension&&t.stat_date===d&&s.push(t),"day"===t.dimension&&t.stat_date===n&&o.push(t)}const p=t.map((e=>e.field)).filter(Boolean);for(const t of l){const e={},a=s.find((e=>e.appid===t)),l=o.find((e=>e.appid===t));for(const t of p)if("appid"===t||"name"===t)e[t]=a&&a[t];else{const i=a&&a[t],s=l&&l[t];e[t+"_value"]=F(i),e[t+"_contrast"]=F(s)}if(t&&(e[`total_${i}s_value`]="获取中..."),this[`${i}TableData`].push(e),t){a[`total_${i}s`]=0;const e=JSON.parse(JSON.stringify(this.query));e.start_time=[I(0),(new Date).getTime()],e.appid=t,$.call(this,e,`total_${i}s`).then((e=>{this[`${i}TableData`].find((e=>e.appid===t))[`total_${i}s_value`]=e}))}}})).catch((e=>{console.error(e)})).finally((()=>{this.loading=!1,this.complete=!0}))},navTo(e,t){e.indexOf("http")>-1?window.open(e):(t&&(e=`${e}?appid=${t}`),i({url:e}))},toUrl(e){window.open(e,"_blank")},toAddAppId(){this.showAddAppId=!1,i({url:"/pages/system/app/list",events:{refreshData:()=>{this.checkAppId()}}})},async checkAppId(){const e=a.database();let t=await e.collection("opendb-app-list").count();this.showAddAppId=!t.result||0===t.result.total},async checkdbInit(){const e=a.database();let t=await e.collection("opendb-admin-menus").count();this.showdbInit=!t.result||0===t.result.total,this.showdbInit&&l({title:"重要提示",content:"检测到您未初始化数据库，请先右键uni-admin项目根目下的 uniCloud/database 目录，执行初始化云数据库，否则左侧无法显示菜单等数据",showCancel:!1,confirmText:"我知道了"})}}},[["render",function(e,t,a,i,l,I){const x=b(m("uni-stat-breadcrumb"),w),D=n,C=b(m("uni-notice-bar"),T),S=b(m("uni-stat-tabs"),A),q=b(m("uni-th"),v),F=b(m("uni-tr"),y),$=b(m("uni-td"),g),j=b(m("uni-table"),k);return s(),o(D,{class:"fix-top-window"},{default:d((()=>[p(D,{class:"uni-header"},{default:d((()=>[p(x,{class:"uni-stat-breadcrumb-on-phone"}),p(D,{class:"uni-group"},{default:d((()=>[p(D,{class:"uni-sub-title hide-on-phone"})])),_:1})])),_:1}),p(D,{class:"uni-container"},{default:d((()=>[l.showdbInit?(s(),o(C,{key:0,showGetMore:"",showIcon:"",class:"mb-m pointer",text:"检测到您未初始化db_init.json，请先右键uniCloud/database/db_init.json文件，执行初始化云数据库，否则左侧无法显示菜单等数据","background-color":"#fef0f0",color:"#f56c6c",onClick:I.toAddAppId},null,8,["onClick"])):u("",!0),l.showAddAppId?(s(),o(C,{key:1,showGetMore:"",showIcon:"",class:"mb-m pointer",text:"检测到您还未添加应用，点击前往应用管理添加",onClick:I.toAddAppId},null,8,["onClick"])):u("",!0),l.deviceTableData.length||l.userTableData.length||l.query.platform_id||!l.complete?u("",!0):(s(),o(C,{key:2,showGetMore:"",showIcon:"",class:"mb-m pointer",text:"暂无数据, 统计相关功能需开通 uni 统计后才能使用, 如未开通, 点击查看具体流程",onClick:t[0]||(t[0]=e=>I.navTo("https://uniapp.dcloud.io/uni-stat-v2.html"))})),p(D,{class:"uni-stat--x mb-m"},{default:d((()=>[p(S,{label:"平台选择",type:"boldLine",mode:"platform",modelValue:l.query.platform_id,"onUpdate:modelValue":t[1]||(t[1]=e=>l.query.platform_id=e)},null,8,["modelValue"])])),_:1}),p(D,{class:"uni-stat--x p-m"},{default:d((()=>[p(D,{class:"uni-stat-card-header"},{default:d((()=>[r("设备概览")])),_:1}),p(j,{loading:l.loading,border:"",stripe:"",emptyText:"暂无数据"},{default:d((()=>[p(F,null,{default:d((()=>[(s(!0),c(h,null,f(I.deviceTableFields,((e,t)=>(s(),c(h,{key:t},[e.title?(s(),o(q,{key:t,align:"center"},{default:d((()=>[r(_(e.title),1)])),_:2},1024)):u("",!0)],64)))),128))])),_:1}),(s(!0),c(h,null,f(l.deviceTableData,((e,a)=>(s(),o(F,{key:a},{default:d((()=>[(s(!0),c(h,null,f(I.deviceTableFields,((a,i)=>(s(),c(h,{key:i},["appid"===a.field?(s(),o($,{key:0,align:"center"},{default:d((()=>[e.appid?(s(),o(D,{key:0,onClick:t=>I.navTo("/pages/uni-stat/device/overview/overview",e.appid),class:"link-btn-color"},{default:d((()=>[r(_(void 0!==e[a.field]?e[a.field]:"-"),1)])),_:2},1032,["onClick"])):(s(),o(D,{key:1,onClick:t[2]||(t[2]=e=>I.navTo("/pages/system/app/add")),class:"link-btn-color"},{default:d((()=>[r(" 需添加此应用的 appid ")])),_:1}))])),_:2},1024)):(s(),o($,{key:i,align:"center"},{default:d((()=>[r(_(void 0!==e[a.field]?e[a.field]:"-"),1)])),_:2},1024))],64)))),128))])),_:2},1024)))),128))])),_:1},8,["loading"])])),_:1}),p(D,{class:"uni-stat--x p-m"},{default:d((()=>[p(D,{class:"uni-stat-card-header"},{default:d((()=>[r("注册用户概览")])),_:1}),p(j,{loading:l.loading,border:"",stripe:"",emptyText:"暂无数据"},{default:d((()=>[p(F,null,{default:d((()=>[(s(!0),c(h,null,f(I.userTableFields,((e,t)=>(s(),c(h,{key:t},[e.title?(s(),o(q,{key:t,align:"center"},{default:d((()=>[r(_(e.title),1)])),_:2},1024)):u("",!0)],64)))),128))])),_:1}),(s(!0),c(h,null,f(l.userTableData,((e,a)=>(s(),o(F,{key:a},{default:d((()=>[(s(!0),c(h,null,f(I.userTableFields,((a,i)=>(s(),c(h,{key:i},["appid"===a.field?(s(),o($,{key:0,align:"center"},{default:d((()=>[e.appid?(s(),o(D,{key:0,onClick:t=>I.navTo("/pages/uni-stat/user/overview/overview",e.appid),class:"link-btn-color"},{default:d((()=>[r(_(void 0!==e[a.field]?e[a.field]:"-"),1)])),_:2},1032,["onClick"])):(s(),o(D,{key:1,onClick:t[3]||(t[3]=e=>I.navTo("/pages/system/app/add")),class:"link-btn-color"},{default:d((()=>[r(" 需添加此应用的 appid ")])),_:1}))])),_:2},1024)):(s(),o($,{key:i,align:"center"},{default:d((()=>[r(_(void 0!==e[a.field]?e[a.field]:"-"),1)])),_:2},1024))],64)))),128))])),_:2},1024)))),128))])),_:1},8,["loading"])])),_:1})])),_:1})])),_:1})}],["__scopeId","data-v-2b2b7388"]]);export{M as default};
