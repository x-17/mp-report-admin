import{_ as e,W as a,n as t,o as n,c as l,w as s,i,a as r,d as o,b as d,e as u,f as c,F as p,g as m,h as f,v as h,t as _,aL as g,j as y,k as b,l as x,u as C,m as q}from"./index-b4e560e4.js";import{_ as k}from"./uni-stat-breadcrumb.15e35830.js";import{_ as $}from"./download-excel.84dfc089.js";import{_ as T}from"./uni-data-select.0d51d389.js";import{_ as v}from"./uni-stat-tabs.c1e62e9b.js";import{_ as w}from"./uni-pagination.60f5d58e.js";import{_ as V}from"./unicloud-db.7f6003eb.js";import{e as D,f as S}from"./uni-pay-orders.a394ab02.js";import{g as j,s as I}from"./util.c5e0d5d8.js";import{t as z}from"./timeUtil.49d57824.js";import"./uni-tooltip.6577854d.js";const E=a.database(),U={ascending:"asc",descending:"desc"};const L=e({data:()=>({collectionList:"uni-pay-orders",query:{appid:"",platform_id:"",uni_platform:"",version:"",pay_date:[],channel_code:""},where:"",orderby:"total_fee desc",orderByFieldName:"",selectedIndexs:[],options:{pageSize:20,pageCurrent:1,filterData:{},...D},imageStyles:{width:64,height:64},exportExcel:{filename:"价值用户排行.xls",type:"xls",fields:{"用户ID":"user_id","用户昵称":"nickname","支付金额":"total_fee","订单数量":"count"}},exportExcelData:[],dateTabs:{time:[],timeStr:"",index:null,list:[{_id:0,name:"今天"},{_id:1,name:"昨天"},{_id:7,name:"最近七天"},{_id:30,name:"最近30天"},{_id:90,name:"最近90天"}]}}),onLoad(){this._filter={}},onReady(){},methods:{payDatePicker(e){this.query.pay_date=e,this.search()},onqueryload(e){this.exportExcelData=e},getWhere(){let e="status>0",{pay_date:a,appid:t,version:n,uni_platform:l,channel_code:s}=this.query;return a&&2==a.length&&(e+=` && pay_date>=${a[0]} && pay_date<=${a[1]}`),t&&(e+=` && appid=='${t}'`),n&&(e+=` && stat_data.app_version=='${n}'`),l&&(e+=` && stat_data.platform=='${l}'`),s&&(e+=` && stat_data.channel=='${s}'`),e=e.trim(),console.log("where: ",e),e},search(){if(!this.query.appid)return;const e=this.getWhere();this.where=e,this.$nextTick((()=>{this.loadData()}))},loadData(e=!0){this.$refs.udb.loadData({clear:e})},onPageChanged(e){this.selectedIndexs.length=0,this.$refs.table.clearSelection(),this.$refs.udb.loadData({current:e.current})},navigateTo(e,a){t({url:e,events:{refreshData:()=>{this.loadData(a)}}})},selectedItems(){let e=this.$refs.udb.dataList;return this.selectedIndexs.map((a=>e[a]._id))},delTable(){this.$refs.udb.remove(this.selectedItems(),{success:e=>{this.$refs.table.clearSelection()}})},selectionChange(e){this.selectedIndexs=e.detail.index},sortChange(e,a){this.orderByFieldName=a,e.order?this.orderby=a+" "+U[e.order]:this.orderby="",this.$refs.table.clearSelection(),this.$nextTick((()=>{this.$refs.udb.loadData()}))},filterChange(e,a){this._filter[a]={type:e.filterType,value:e.filter};let t=S(this._filter,E.command);Object.keys(t).length?this.where=t:this.where="",this.$nextTick((()=>{this.$refs.udb.loadData()}))},platformChange(e,a,t,n){this.query.version=0,this.query.uni_platform=n.code},nameFormat:e=>e.user_id?e.nickname?`${e.user_id}（${e.nickname}）`:e.user_id:"匿名用户",pageToUser(e){let{user_id:a}=e;t({url:`/pages/system/user/list?id=${a}`})},pageToOrder(e){let{user_id:a}=e;t({url:`/pages/uni-stat/pay-order/list/list?user_id=${a}`})},dateTabsChange(e,a){this.dateTabs.index=a;let t=j(e),n=z.getOffsetStartAndEnd("day",0).endTime;1==e&&(n=z.getOffsetStartAndEnd("day",0,t).endTime),this.query.pay_date=[t,n]}},watch:{query:{deep:!0,handler(e){this.search()}}},computed:{versionQuery(){const{appid:e,uni_platform:a}=this.query;return I({appid:e,uni_platform:a})},channelQuery(){const{appid:e,platform_id:a}=this.query;return I({appid:e,platform_id:a})}}},[["render",function(e,a,t,D,S,j){const I=m(f("uni-stat-breadcrumb"),k),z=i,E=h,U=m(f("download-excel"),$),L=m(f("uni-data-select"),T),F=m(f("uni-stat-tabs"),v),O=m(f("uni-datetime-picker"),g),Q=m(f("uni-th"),y),P=m(f("uni-tr"),b),W=m(f("uni-td"),x),A=C,B=m(f("uni-table"),q),N=m(f("uni-pagination"),w),R=m(f("unicloud-db"),V);return n(),l(z,null,{default:s((()=>[r(z,{class:"uni-header"},{default:s((()=>[r(z,{class:"uni-group"},{default:s((()=>[r(I)])),_:1}),r(z,{class:"uni-group"},{default:s((()=>[r(E,{class:"uni-button",type:"default",size:"mini",onClick:j.search},{default:s((()=>[o("搜索")])),_:1},8,["onClick"]),r(U,{class:"hide-on-phone",fields:S.exportExcel.fields,data:S.exportExcelData,type:S.exportExcel.type,name:S.exportExcel.filename},{default:s((()=>[r(E,{class:"uni-button",type:"primary",size:"mini"},{default:s((()=>[o("导出 Excel")])),_:1})])),_:1},8,["fields","data","type","name"])])),_:1})])),_:1}),r(z,{class:"uni-container"},{default:s((()=>[r(z,{class:"uni-stat--x flex p-1015"},{default:s((()=>[r(L,{collection:"opendb-app-list",field:"appid as value, name as text",orderby:"text asc",defItem:1,label:"应用选择",modelValue:S.query.appid,"onUpdate:modelValue":a[0]||(a[0]=e=>S.query.appid=e),clear:!1},null,8,["modelValue"]),r(L,{collection:"opendb-app-versions",where:j.versionQuery,class:"ml-m",field:"_id as value, version as text, uni_platform as label, create_date as date",format:"{label} - {text}",orderby:"date desc",label:"版本选择",modelValue:S.query.version_id,"onUpdate:modelValue":a[1]||(a[1]=e=>S.query.version_id=e)},null,8,["where","modelValue"])])),_:1}),r(z,{class:"uni-stat--x",style:{"margin-bottom":"0"}},{default:s((()=>[r(F,{label:"平台选择",type:"boldLine",mode:"platform",modelValue:S.query.platform_id,"onUpdate:modelValue":a[2]||(a[2]=e=>S.query.platform_id=e),onChange:j.platformChange},null,8,["modelValue","onChange"]),S.query.platform_id&&-1===S.query.platform_id.indexOf("==")?(n(),l(L,{key:0,ref:"version-select",collection:"uni-stat-app-channels",where:j.channelQuery,class:"p-channel",field:"channel_code as value, channel_name as text",orderby:"text asc",label:"渠道/场景值选择",modelValue:S.query.channel_code,"onUpdate:modelValue":a[3]||(a[3]=e=>S.query.channel_code=e)},null,8,["where","modelValue"])):d("",!0)])),_:1}),r(z,{class:"flex"},{default:s((()=>[r(F,{type:"box",current:S.dateTabs.index,tabs:S.dateTabs.list,onChange:j.dateTabsChange},null,8,["current","tabs","onChange"]),r(O,{type:"datetimerange",modelValue:S.query.pay_date,"onUpdate:modelValue":a[4]||(a[4]=e=>S.query.pay_date=e),end:Date.now(),"return-type":"timestamp","clear-icon":!0,class:"uni-stat-datetime-picker",onChange:a[5]||(a[5]=e=>S.dateTabs.index=null)},null,8,["modelValue","end"])])),_:1}),r(R,{ref:"udb",collection:S.collectionList,field:"user_id,nickname,uni_platform,status,total_fee,refund_fee,appid,pay_date",where:S.where,"page-data":"replace",orderby:S.orderby,getcount:!0,"page-size":S.options.pageSize,"page-current":S.options.pageCurrent,groupby:"user_id","group-field":"sum(total_fee) as total_fee,sum(refund_fee) as refund_fee, sum(subtract(total_fee,refund_fee)) as reality_fee, sum(1) as count,last(nickname) as nickname",options:S.options,loadtime:"manual",onLoad:j.onqueryload},{default:s((({data:e,pagination:t,loading:i,error:d,options:m})=>[r(B,{ref:"table",loading:i,emptyText:d.message||i?"请求中...":"没有更多数据",border:"",stripe:"",type:"",style:{"min-height":"900px"},onSelectionChange:j.selectionChange},{default:s((()=>[r(P,null,{default:s((()=>[r(Q,{align:"center"},{default:s((()=>[o("排名")])),_:1}),r(Q,{align:"center",sortable:"",onSortChange:a[6]||(a[6]=e=>j.sortChange(e,"user_id"))},{default:s((()=>[o("用户")])),_:1}),r(Q,{align:"center",sortable:"",onSortChange:a[7]||(a[7]=e=>j.sortChange(e,"reality_fee"))},{default:s((()=>[o("支付金额（不含退款）")])),_:1}),r(Q,{align:"center",sortable:"",onSortChange:a[8]||(a[8]=e=>j.sortChange(e,"count"))},{default:s((()=>[o("订单数量")])),_:1})])),_:1}),(n(!0),u(p,null,c(e,((e,a)=>(n(),l(P,{key:a},{default:s((()=>[r(W,{align:"center"},{default:s((()=>[o(_(parseInt(a+1+(t.current-1)*t.size)),1)])),_:2},1024),r(W,{align:"center"},{default:s((()=>[r(A,{class:"text-btn",onClick:a=>j.pageToUser(e)},{default:s((()=>[o(_(j.nameFormat(e)),1)])),_:2},1032,["onClick"])])),_:2},1024),r(W,{align:"center"},{default:s((()=>[o(_((e.reality_fee/100).toFixed(2)),1)])),_:2},1024),r(W,{align:"center"},{default:s((()=>[r(A,{class:"text-btn",onClick:a=>j.pageToOrder(e)},{default:s((()=>[o(_(e.count),1)])),_:2},1032,["onClick"])])),_:2},1024)])),_:2},1024)))),128))])),_:2},1032,["loading","emptyText","onSelectionChange"]),r(z,{class:"uni-pagination-box"},{default:s((()=>[r(N,{"show-icon":"","page-size":t.size,modelValue:t.current,"onUpdate:modelValue":e=>t.current=e,total:t.count,onChange:j.onPageChanged},null,8,["page-size","modelValue","onUpdate:modelValue","total","onChange"])])),_:2},1024)])),_:1},8,["collection","where","orderby","page-size","page-current","options","onLoad"])])),_:1})])),_:1})}],["__scopeId","data-v-c7f3b2c1"]]);export{L as default};
